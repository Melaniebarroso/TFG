<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Administración</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <header class="bg-white shadow p-6 mb-8">
    <h1 class="text-3xl font-bold">Bienvenido, {{ admin.nombre }}</h1>
  </header>

  <main class="container mx-auto px-4 space-y-10">

    <section class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
      <h2 class="text-2xl font-semibold mb-5 border-b pb-2">Estadísticas</h2>
      <canvas id="alumnosChart" class="w-full max-w-md mx-auto mb-4" style="width: 300px;"></canvas>
      <p class="text-center text-lg font-medium">Total de alumnos: <strong>{{ total_alumnos }}</strong></p>
      <script>
        const ctx = document.getElementById('alumnosChart');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Alumnos Inscritos', 'Meta Restante'],
            datasets: [{
              data: [{{ porcentaje_alumnos }}, {{ porcentaje_restante }}],
              backgroundColor: ['#4caf50', '#e6e6e6'],
              hoverOffset: 6
            }]
          },
          options: {
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      </script>
    </section>
<section class="bg-white p-6 rounded-lg shadow-md border-4 border-blue-400">
  <h2 class="text-2xl font-semibold mb-5 border-b-2 border-blue-400 pb-2">Crear nuevo post del blog</h2>
  <form method="POST" enctype="multipart/form-data" class="space-y-4">
    {% csrf_token %}

    {{ form.as_p }}
    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded transition">Publicar</button>
  </form>
</section>

<section class="bg-white p-6 rounded-lg shadow-md border-4 border-green-400">
  <h2 class="text-2xl font-semibold mb-5 border-b-2 border-green-400 pb-2">Lista de Alumnos</h2>
  <table class="min-w-full text-sm border-collapse border border-green-300">
    <thead class="bg-green-100">
      <tr>
        <th class="text-left p-3 border border-green-300">Nombre</th>
        <th class="text-left p-3 border border-green-300">Apellidos</th>
        <th class="text-left p-3 border border-green-300">Email</th>
      </tr>
    </thead>
    <tbody>
      {% for alumno in alumnos %}
      <tr class="border-b hover:bg-green-50">
        <td class="p-3 border border-green-300">{{ alumno.nombre }}</td>
        <td class="p-3 border border-green-300">{{ alumno.apellidos }}</td>
        <td class="p-3 border border-green-300">{{ alumno.email }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="bg-white p-6 rounded-lg shadow-md border-4 border-purple-400">
  <h2 class="text-2xl font-semibold mb-6 border-b-2 border-purple-400 pb-3">Cursos y Alumnos Inscritos</h2>
  <div class="space-y-8">
    {% for curso in cursos %}
      <div class="border rounded-lg p-5 bg-purple-50 shadow-sm">
        <h3 class="text-xl font-semibold mb-4 text-purple-700">{{ curso.nombre }}</h3>
        
        <div class="inline-flex rounded bg-purple-200 mb-5 overflow-hidden">
          <button 
            class="tab-button px-5 py-2 font-medium focus:outline-none bg-white border-b-4 border-purple-600"
            data-tab-target="#alumnos-{{ curso.id }}"
            type="button"
          >Alumnos</button>
          <button 
            class="tab-button px-5 py-2 font-medium focus:outline-none text-purple-600 hover:text-purple-900"
            data-tab-target="#materiales-{{ curso.id }}"
            type="button"
          >Materiales</button>
        </div>

        <div>
          <div id="alumnos-{{ curso.id }}" class="tab-content">
            {% if curso.inscripcion_set.all %}
              <ul class="list-disc pl-6 space-y-1 text-purple-900">
                {% for inscripcion in curso.inscripcion_set.all %}
                  <li>{{ inscripcion.alumno.nombre }} {{ inscripcion.alumno.apellidos }}</li>
                {% empty %}
                  <li>No hay alumnos inscritos.</li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-purple-700">No hay alumnos inscritos.</p>
            {% endif %}
          </div>

          <div id="materiales-{{ curso.id }}" class="tab-content hidden">
            <ul class="list-disc pl-6 mb-6 space-y-1 text-purple-700">
              {% for material in curso.materiales.all %}
                <li><a href="{{ material.archivo.url }}" target="_blank" class="underline hover:text-purple-900">{{ material.titulo }}</a></li>
              {% empty %}
                <li class="text-purple-600">No hay materiales.</li>
              {% endfor %}
            </ul>

            <form 
              action="{% url 'subir_material' admin.id curso.id %}" 
              method="POST" enctype="multipart/form-data"
              ondragover="event.preventDefault()" 
              ondrop="event.preventDefault(); this.querySelector('input[type=file]').files = event.dataTransfer.files;"
              class="border-2 border-dashed border-purple-400 p-4 rounded cursor-pointer text-center text-purple-600 hover:border-purple-700 transition"
            >
              {% csrf_token %}
              <input 
                type="text" name="titulo" placeholder="Título del material" required
                class="border-2 border-purple-600 rounded-md p-2 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-purple-700"
              />
              <input 
                type="file" name="archivo" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" required
                class="block mb-3 mx-auto"
              />
              <button 
                type="submit" 
                class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded transition"
              >Subir Material</button>
              <p class="mt-2 text-sm text-purple-500">Arrastra archivos aquí o haz clic para seleccionar.</p>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<!-- Pedidos -->
<section class="bg-white p-6 rounded-lg shadow-md border-4 border-red-400">
  <h2 class="text-2xl font-semibold mb-5 border-b-2 border-red-400 pb-2">Pedidos Realizados</h2>
  <table class="min-w-full text-sm border-collapse border border-red-300">
    <thead class="bg-red-100">
      <tr>
        <th class="p-3 border border-red-300">ID</th>
        <th class="p-3 border border-red-300">Cliente</th>
        <th class="p-3 border border-red-300">Email</th>
        <th class="p-3 border border-red-300">Fecha</th>
        <th class="p-3 border border-red-300">Estado</th>
        <th class="p-3 border border-red-300">Detalles</th>
      </tr>
    </thead>
    <tbody>
      {% for pedido in pedidos %}
      <tr class="border-b hover:bg-red-50">
        <td class="p-3 border border-red-300">{{ pedido.id }}</td>
        <td class="p-3 border border-red-300">{{ pedido.nombre_cliente }}</td>
        <td class="p-3 border border-red-300">{{ pedido.email_cliente }}</td>
        <td class="p-3 border border-red-300">{{ pedido.fecha|date:"d/m/Y H:i" }}</td>
        <td class="p-3 border border-red-300">{{ pedido.estado }}</td>
        <td class="p-3 border border-red-300">
          <a href="{% url 'detalle_pedido' admin.id pedido.id %}" class="text-red-600 hover:underline font-medium">Ver</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="p-4 text-center text-red-600">No hay pedidos.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>


  </main>

  <footer class="bg-gray-200 text-center text-sm py-4 mt-12">
    &copy; {{ now|date:"Y" }}. Todos los derechos reservados.
  </footer>

  <script>
    // Tabs functionality
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const parent = button.closest('div.border, div.bg-gray-50');
        if (!parent) return;
        parent.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        parent.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('bg-white', 'font-bold', 'border-b-4', 'border-blue-600');
          btn.classList.add('bg-gray-200', 'text-gray-600');
        });

        const target = document.querySelector(button.dataset.tabTarget);
        if (target) target.classList.remove('hidden');

        button.classList.remove('bg-gray-200', 'text-gray-600');
        button.classList.add('bg-white', 'font-bold', 'border-b-4', 'border-blue-600');
      });
    });

    // Initialize first tab visible for each curso
    document.querySelectorAll('div.bg-gray-50').forEach(div => {
      const firstTab = div.querySelector('.tab-button');
      if (firstTab) firstTab.click();
    });
  </script>

</body>
</html>
